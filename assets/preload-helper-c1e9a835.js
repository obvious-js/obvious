var F=function(t,e){return F=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(n[s]=r[s])},F(t,e)};function ht(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");F(t,e);function n(){this.constructor=t}t.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}function It(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function c(u){try{a(r.next(u))}catch(f){o(f)}}function l(u){try{a(r.throw(u))}catch(f){o(f)}}function a(u){u.done?i(u.value):s(u.value).then(c,l)}a((r=r.apply(t,e||[])).next())})}function kt(t,e){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,s,i,o;return o={next:c(0),throw:c(1),return:c(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function c(a){return function(u){return l([a,u])}}function l(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(n=0)),n;)try{if(r=1,s&&(i=a[0]&2?s.return:a[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,a[1])).done)return i;switch(s=0,i&&(a=[a[0]&2,i.value]),a[0]){case 0:case 1:i=a;break;case 4:return n.label++,{value:a[1],done:!1};case 5:n.label++,s=a[1],a=[0];continue;case 7:a=n.ops.pop(),n.trys.pop();continue;default:if(i=n.trys,!(i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1],i=a;break}if(i&&n.label<i[2]){n.label=i[2],n.ops.push(a);break}i[2]&&n.ops.pop(),n.trys.pop();continue}a=e.call(t,n)}catch(u){a=[6,u],s=0}finally{r=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}}var A=function(){return A=Object.assign||function(e){for(var n,r=1,s=arguments.length;r<s;r++){n=arguments[r];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},A.apply(this,arguments)};function b(t,e,n,r){function s(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function c(u){try{a(r.next(u))}catch(f){o(f)}}function l(u){try{a(r.throw(u))}catch(f){o(f)}}function a(u){u.done?i(u.value):s(u.value).then(c,l)}a((r=r.apply(t,e||[])).next())})}function y(t,e){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,s,i,o;return o={next:c(0),throw:c(1),return:c(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function c(a){return function(u){return l([a,u])}}function l(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(n=0)),n;)try{if(r=1,s&&(i=a[0]&2?s.return:a[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,a[1])).done)return i;switch(s=0,i&&(a=[a[0]&2,i.value]),a[0]){case 0:case 1:i=a;break;case 4:return n.label++,{value:a[1],done:!1};case 5:n.label++,s=a[1],a=[0];continue;case 7:a=n.ops.pop(),n.trys.pop();continue;default:if(i=n.trys,!(i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1],i=a;break}if(i&&n.label<i[2]){n.label=i[2],n.ops.push(a);break}i[2]&&n.ops.pop(),n.trys.pop();continue}a=e.call(t,n)}catch(u){a=[6,u],s=0}finally{r=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}}function g(t,e,n){if(n||arguments.length===2)for(var r=0,s=e.length,i;r<s;r++)(i||!(r in e))&&(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))}function Lt(t,e){const n=Object.create(null),r=t.split(",");for(let s=0;s<r.length;s++)n[r[s]]=!0;return e?s=>!!n[s.toLowerCase()]:s=>!!n[s]}const Mt=Object.assign,Ct=Object.prototype.hasOwnProperty,K=(t,e)=>Ct.call(t,e),m=Array.isArray,z=t=>dt(t)==="[object Map]",Nt=t=>typeof t=="string",Y=t=>typeof t=="symbol",W=t=>t!==null&&typeof t=="object",Pt=Object.prototype.toString,dt=t=>Pt.call(t),Ut=t=>dt(t).slice(8,-1),J=t=>Nt(t)&&t!=="NaN"&&t[0]!=="-"&&""+parseInt(t,10)===t,pt=(t,e)=>!Object.is(t,e),jt=t=>{const e=parseFloat(t);return isNaN(e)?t:e};let zt;function vt(t,e=zt){e&&e.active&&e.effects.push(t)}const wt=t=>{const e=new Set(t);return e.w=0,e.n=0,e},bt=t=>(t.w&S)>0,yt=t=>(t.n&S)>0,Kt=({deps:t})=>{if(t.length)for(let e=0;e<t.length;e++)t[e].w|=S},Wt=t=>{const{deps:e}=t;if(e.length){let n=0;for(let r=0;r<e.length;r++){const s=e[r];bt(s)&&!yt(s)?s.delete(t):e[n++]=s,s.w&=~S,s.n&=~S}e.length=n}},G=new WeakMap;let I=0,S=1;const $=30;let w;const x=Symbol(""),H=Symbol("");class Dt{constructor(e,n=null,r){this.fn=e,this.scheduler=n,this.active=!0,this.deps=[],this.parent=void 0,vt(this,r)}run(){if(!this.active)return this.fn();let e=w,n=R;for(;e;){if(e===this)return;e=e.parent}try{return this.parent=w,w=this,R=!0,S=1<<++I,I<=$?Kt(this):nt(this),this.fn()}finally{I<=$&&Wt(this),S=1<<--I,w=this.parent,R=n,this.parent=void 0,this.deferStop&&this.stop()}}stop(){w===this?this.deferStop=!0:this.active&&(nt(this),this.onStop&&this.onStop(),this.active=!1)}}function nt(t){const{deps:e}=t;if(e.length){for(let n=0;n<e.length;n++)e[n].delete(t);e.length=0}}function Ft(t,e){t.effect&&(t=t.effect.fn);const n=new Dt(t);e&&(Mt(n,e),e.scope&&vt(n,e.scope)),(!e||!e.lazy)&&n.run();const r=n.run.bind(n);return r.effect=n,r}let R=!0;const Et=[];function Gt(){Et.push(R),R=!1}function $t(){const t=Et.pop();R=t===void 0?!0:t}function v(t,e,n){if(R&&w){let r=G.get(t);r||G.set(t,r=new Map);let s=r.get(n);s||r.set(n,s=wt()),Ht(s)}}function Ht(t,e){let n=!1;I<=$?yt(t)||(t.n|=S,n=!bt(t)):n=!t.has(w),n&&(t.add(w),w.deps.push(t))}function _(t,e,n,r,s,i){const o=G.get(t);if(!o)return;let c=[];if(e==="clear")c=[...o.values()];else if(n==="length"&&m(t)){const l=jt(r);o.forEach((a,u)=>{(u==="length"||u>=l)&&c.push(a)})}else switch(n!==void 0&&c.push(o.get(n)),e){case"add":m(t)?J(n)&&c.push(o.get("length")):(c.push(o.get(x)),z(t)&&c.push(o.get(H)));break;case"delete":m(t)||(c.push(o.get(x)),z(t)&&c.push(o.get(H)));break;case"set":z(t)&&c.push(o.get(x));break}if(c.length===1)c[0]&&rt(c[0]);else{const l=[];for(const a of c)a&&l.push(...a);rt(wt(l))}}function rt(t,e){const n=m(t)?t:[...t];for(const r of n)r.computed&&it(r);for(const r of n)r.computed||it(r)}function it(t,e){(t!==w||t.allowRecurse)&&(t.scheduler?t.scheduler():t.run())}const Vt=Lt("__proto__,__v_isRef,__isVue"),gt=new Set(Object.getOwnPropertyNames(Symbol).filter(t=>t!=="arguments"&&t!=="caller").map(t=>Symbol[t]).filter(Y)),Yt=mt(),Jt=mt(!0),st=qt();function qt(){const t={};return["includes","indexOf","lastIndexOf"].forEach(e=>{t[e]=function(...n){const r=h(this);for(let i=0,o=this.length;i<o;i++)v(r,"get",i+"");const s=r[e](...n);return s===-1||s===!1?r[e](...n.map(h)):s}}),["push","pop","shift","unshift","splice"].forEach(e=>{t[e]=function(...n){Gt();const r=h(this)[e].apply(this,n);return $t(),r}}),t}function mt(t=!1,e=!1){return function(r,s,i){if(s==="__v_isReactive")return!t;if(s==="__v_isReadonly")return t;if(s==="__v_isShallow")return e;if(s==="__v_raw"&&i===(t?e?he:Bt:e?fe:_t).get(r))return r;const o=m(r);if(!t&&o&&K(st,s))return Reflect.get(st,s,i);const c=Reflect.get(r,s,i);return(Y(s)?gt.has(s):Vt(s))||(t||v(r,"get",s),e)?c:k(c)?o&&J(s)?c:c.value:W(c)?t?L(c):Z(c):c}}const Zt=Qt();function Qt(t=!1){return function(n,r,s,i){let o=n[r];if(V(o)&&k(o)&&!k(s))return!1;if(!t&&(!ve(s)&&!V(s)&&(o=h(o),s=h(s)),!m(n)&&k(o)&&!k(s)))return o.value=s,!0;const c=m(n)&&J(r)?Number(r)<n.length:K(n,r),l=Reflect.set(n,r,s,i);return n===h(i)&&(c?pt(s,o)&&_(n,"set",r,s):_(n,"add",r,s)),l}}function Xt(t,e){const n=K(t,e);t[e];const r=Reflect.deleteProperty(t,e);return r&&n&&_(t,"delete",e,void 0),r}function te(t,e){const n=Reflect.has(t,e);return(!Y(e)||!gt.has(e))&&v(t,"has",e),n}function ee(t){return v(t,"iterate",m(t)?"length":x),Reflect.ownKeys(t)}const ne={get:Yt,set:Zt,deleteProperty:Xt,has:te,ownKeys:ee},re={get:Jt,set(t,e){return!0},deleteProperty(t,e){return!0}},q=t=>t,D=t=>Reflect.getPrototypeOf(t);function M(t,e,n=!1,r=!1){t=t.__v_raw;const s=h(t),i=h(e);n||(e!==i&&v(s,"get",e),v(s,"get",i));const{has:o}=D(s),c=r?q:n?X:Q;if(o.call(s,e))return c(t.get(e));if(o.call(s,i))return c(t.get(i));t!==s&&t.get(e)}function C(t,e=!1){const n=this.__v_raw,r=h(n),s=h(t);return e||(t!==s&&v(r,"has",t),v(r,"has",s)),t===s?n.has(t):n.has(t)||n.has(s)}function N(t,e=!1){return t=t.__v_raw,!e&&v(h(t),"iterate",x),Reflect.get(t,"size",t)}function ot(t){t=h(t);const e=h(this);return D(e).has.call(e,t)||(e.add(t),_(e,"add",t,t)),this}function at(t,e){e=h(e);const n=h(this),{has:r,get:s}=D(n);let i=r.call(n,t);i||(t=h(t),i=r.call(n,t));const o=s.call(n,t);return n.set(t,e),i?pt(e,o)&&_(n,"set",t,e):_(n,"add",t,e),this}function ct(t){const e=h(this),{has:n,get:r}=D(e);let s=n.call(e,t);s||(t=h(t),s=n.call(e,t)),r&&r.call(e,t);const i=e.delete(t);return s&&_(e,"delete",t,void 0),i}function ut(){const t=h(this),e=t.size!==0,n=t.clear();return e&&_(t,"clear",void 0,void 0),n}function P(t,e){return function(r,s){const i=this,o=i.__v_raw,c=h(o),l=e?q:t?X:Q;return!t&&v(c,"iterate",x),o.forEach((a,u)=>r.call(s,l(a),l(u),i))}}function U(t,e,n){return function(...r){const s=this.__v_raw,i=h(s),o=z(i),c=t==="entries"||t===Symbol.iterator&&o,l=t==="keys"&&o,a=s[t](...r),u=n?q:e?X:Q;return!e&&v(i,"iterate",l?H:x),{next(){const{value:f,done:B}=a.next();return B?{value:f,done:B}:{value:c?[u(f[0]),u(f[1])]:u(f),done:B}},[Symbol.iterator](){return this}}}}function E(t){return function(...e){return t==="delete"?!1:this}}function ie(){const t={get(i){return M(this,i)},get size(){return N(this)},has:C,add:ot,set:at,delete:ct,clear:ut,forEach:P(!1,!1)},e={get(i){return M(this,i,!1,!0)},get size(){return N(this)},has:C,add:ot,set:at,delete:ct,clear:ut,forEach:P(!1,!0)},n={get(i){return M(this,i,!0)},get size(){return N(this,!0)},has(i){return C.call(this,i,!0)},add:E("add"),set:E("set"),delete:E("delete"),clear:E("clear"),forEach:P(!0,!1)},r={get(i){return M(this,i,!0,!0)},get size(){return N(this,!0)},has(i){return C.call(this,i,!0)},add:E("add"),set:E("set"),delete:E("delete"),clear:E("clear"),forEach:P(!0,!0)};return["keys","values","entries",Symbol.iterator].forEach(i=>{t[i]=U(i,!1,!1),n[i]=U(i,!0,!1),e[i]=U(i,!1,!0),r[i]=U(i,!0,!0)}),[t,n,e,r]}const[se,oe,ae,ce]=ie();function St(t,e){const n=e?t?ce:ae:t?oe:se;return(r,s,i)=>s==="__v_isReactive"?!t:s==="__v_isReadonly"?t:s==="__v_raw"?r:Reflect.get(K(n,s)&&s in r?n:r,s,i)}const ue={get:St(!1,!1)},le={get:St(!0,!1)},_t=new WeakMap,fe=new WeakMap,Bt=new WeakMap,he=new WeakMap;function de(t){switch(t){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function pe(t){return t.__v_skip||!Object.isExtensible(t)?0:de(Ut(t))}function Z(t){return V(t)?t:At(t,!1,ne,ue,_t)}function L(t){return At(t,!0,re,le,Bt)}function At(t,e,n,r,s){if(!W(t)||t.__v_raw&&!(e&&t.__v_isReactive))return t;const i=s.get(t);if(i)return i;const o=pe(t);if(o===0)return t;const c=new Proxy(t,o===2?r:n);return s.set(t,c),c}function V(t){return!!(t&&t.__v_isReadonly)}function ve(t){return!!(t&&t.__v_isShallow)}function h(t){const e=t&&t.__v_raw;return e?h(e):t}const Q=t=>W(t)?Z(t):t,X=t=>W(t)?L(t):t;function k(t){return!!(t&&t.__v_isRef===!0)}var d={removeNonExistedBroadcast:function(t){return"[@rallie/core] you are trying to remove a listener of the broadcast event ".concat(t,", but ").concat(t," hasn't been registed as a broadcast event")},wrongBroadcastCallback:function(t){return"[@rallie/core] you are trying to remove a listener of the broadcast event ".concat(t,", but the listener hasn't been registed")},broadcastCallbackError:function(t){return"[@rallie/core] one of the callbacks of the broadcast event ".concat(t," throws an uncaught error")},removeNonExistedUnicast:function(t){return"[@rallie/core] you are trying to remove a listener of the unicast event ".concat(t,", but ").concat(t," hasn't been registed as a unicast event")},registedExistedUnicast:function(t){return"[@rallie/core] you are trying to register a unicast event ".concat(t,", but it has been registered before")},emittedNonExistedUnicast:function(t){return"[@rallie/core] you have emitted ".concat(t," unicast, but there is no listener of this event")},createExistingApp:function(t){return"[@rallie/core] ".concat(t," is existing, you are not allowed to create it again")},resourceNotDeclared:function(t,e){return"[@rallie/core] can not find any assets of the app ".concat(t," on the bus ").concat(e)},appNotCreated:function(t){return"[@rallie/core] you are trying to activate app ".concat(t,", but it was not created")},modifyPrivateState:function(t){return"[@rallie/core] state ".concat(t," is private, you are not allowed to set it")},actionIsNotDefined:function(t){return"[@rallie/core] please describe your action when you modify the state ".concat(t)},accessUninitializedState:function(t){return"[@rallie/core] it's not allowed to set or watch state ".concat(t," before it is initialized")},duplicatedInitial:function(t){return"[@rallie/core] duplicated initialized state ".concat(t)},initializePrimitiveState:function(t){return"[@rallie/core] it's not allowed to initialized state ".concat(t," to a primitive value")},duplicatedBus:function(t){return"[@rallie/core] the bus named ".concat(t," has been defined before, please rename your bus")},circularDependencies:function(t,e){return"[@rallie/core] There is a circular dependency when activating the app ".concat(t,", and the circular path is ").concat(e.join("->"))},multipleCalledNextFn:function(){return"[@rallie/core] next() called multiple times in the middleware"},wrongMiddlewareType:function(){return"[@rallie/core] the middleware must be a function"}},we={handlerIsNotInTheEventsPool:function(t,e){return"[@rallie/core] the event ".concat(t," is not in the events pool that you specified when calling on").concat(e?"Unicast":"Broadcast")}};function be(t){return["string","number","boolean","undefined"].includes(typeof t)}var lt=function(t){return function(e,n){var r=-1,s=function(i){if(i<=r)return Promise.reject(new Error(d.multipleCalledNextFn()));r=i;var o=t[i];if(i===t.length&&(o=n),!o)return Promise.resolve();try{return Promise.resolve(o(e,s.bind(null,i+1)))}catch(c){return Promise.reject(c)}};return s(0)}},ye=function(){function t(){this.broadcastEvents={},this.unicastEvents={}}return t.prototype.addBroadcastEventListener=function(e,n){this.broadcastEvents[e]=this.broadcastEvents[e]||new Set;var r=this.broadcastEvents[e];r.add(n)},t.prototype.addUnicastEventListener=function(e,n){if(this.unicastEvents[e])throw new Error(d.registedExistedUnicast(e));this.unicastEvents[e]=n},t.prototype.removeBroadcastEventListener=function(e,n){var r=this.broadcastEvents[e];if(r)if(r.has(n))r.delete(n);else{var s=d.wrongBroadcastCallback(e);throw new Error(s)}else{var s=d.removeNonExistedBroadcast(e);throw new Error(s)}},t.prototype.removeUnicastEventListener=function(e){if(!this.unicastEvents[e]){var n=d.removeNonExistedUnicast(e);throw new Error(n)}delete this.unicastEvents[e]},t.prototype.emitBroadcast=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.broadcastEvents[e]=this.broadcastEvents[e]||new Set;var s=this.broadcastEvents[e];s.forEach(function(i){try{i.apply(void 0,n)}catch(o){console.error(d.broadcastCallbackError(e)),console.error(o)}})},t.prototype.emitUnicast=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var s=this.unicastEvents[e];if(s)return s.apply(void 0,n);throw new Error(d.emittedNonExistedUnicast(e))},t}(),Ee=function(){function t(e,n){this.namespace=e,this.stores=n,this.stores[e].watchers.add(this)}return t.prototype.do=function(e){var n=this;return this.handler=e,function(){return n.unwatch()}},t.prototype.unwatch=function(){this===null||this===void 0||this.stopEffect(),this.handler=null;var e=this.stores[this.namespace].watchers;e.has(this)&&e.delete(this)},t}(),ge="$state-initialized",me=function(){function t(e,n){this.eventEmitter=e,this.stores=n,this.eventEmitter=e,this.stores=n}return t.prototype.offEvents=function(e,n,r){var s=n?this.eventEmitter.removeUnicastEventListener:this.eventEmitter.removeBroadcastEventListener;s=s.bind(this.eventEmitter),r?e[r]?(s(r,e[r]),delete e[r]):console.warn(we.handlerIsNotInTheEventsPool(r,n)):Object.entries(e).forEach(function(i){var o=i[0],c=i[1];s(o,c)})},t.prototype.onBroadcast=function(e){var n=this;return Object.entries(e).forEach(function(r){var s=r[0],i=r[1];n.eventEmitter.addBroadcastEventListener(s,i)}),function(r){n.offEvents(e,!1,r)}},t.prototype.onUnicast=function(e){var n=this;return Object.entries(e).forEach(function(r){var s=r[0],i=r[1];try{n.eventEmitter.addUnicastEventListener(s,i)}catch(o){console.error(o)}}),function(r){n.offEvents(e,!0,r)}},t.prototype.createBroadcaster=function(e){var n=this;return new Proxy({},{get:function(r,s){return function(){for(var i,o=[],c=0;c<arguments.length;c++)o[c]=arguments[c];return e==null||e(s),(i=n.eventEmitter).emitBroadcast.apply(i,g([s],o,!1))}},set:function(){return!1}})},t.prototype.createUnicaster=function(e){var n=this;return new Proxy({},{get:function(r,s){return function(){for(var i,o=[],c=0;c<arguments.length;c++)o[c]=arguments[c];return e==null||e(s),(i=n.eventEmitter).emitUnicast.apply(i,g([s],o,!1))}},set:function(){return!1}})},t.prototype.existState=function(e){return!!this.stores[e]},t.prototype.initState=function(e,n,r){if(r===void 0&&(r=!1),this.existState(e))throw new Error(d.duplicatedInitial(e));if(be(n))throw new Error(d.initializePrimitiveState(e));return this.stores[e]={state:Z(n),owner:r?this:null,watchers:new Set},this.eventEmitter.emitBroadcast(ge,e),this.getState(e)},t.prototype.getState=function(e,n){if(this.existState(e)){var r=L(this.stores[e].state);return n?n(r):r}else return null},t.prototype.getStateToSet=function(e){if(!this.existState(e)){var n=d.accessUninitializedState(e);throw new Error(n)}var r=this.stores[e].owner;if(r!==this&&r!==null){var n=d.modifyPrivateState(e);throw new Error(n)}return this.stores[e].state},t.prototype.setState=function(e,n,r){return b(this,void 0,void 0,function(){var s,i;return y(this,function(o){switch(o.label){case 0:return s=this.getStateToSet(e),n?(i=r(s),[4,Promise.resolve(i)]):[3,2];case 1:return o.sent(),[3,3];case 2:throw new Error(d.actionIsNotDefined(e));case 3:return[2]}})})},t.prototype.watchState=function(e,n){if(!this.existState(e)){var r=d.accessUninitializedState(e);throw new Error(r)}var s=!1,i=L(this.stores[e].state),o=new Ee(e,this.stores),c=Ft(function(){return n(i)},{lazy:!0,scheduler:function(){s||(s=!0,Promise.resolve().then(function(){var l,a=h(n(i));(l=o.handler)===null||l===void 0||l.call(o,a,o.oldWatchingStates),o.oldWatchingStates=h(a),s=!1}))}});return o.oldWatchingStates=c(),o.stopEffect=function(){return c.effect.stop()},o},t}(),Se=function(){function t(e){this.name=e,this.activated=null,this.dependencies=[],this.relatedApps=[],this.name=e,this.isRallieCoreApp=!0}return t.prototype.relateTo=function(e){return this.relatedApps=Array.from(new Set(g(g([],this.relatedApps,!0),e,!0))),this},t.prototype.relyOn=function(e){return this.relateTo(e),this.dependencies=Array.from(new Set(g(g([],this.dependencies,!0),e,!0))),this},t.prototype.onActivate=function(e){return this.doActivate=e,this},t}(),_e=function(t){return b(void 0,void 0,void 0,function(){var e;return y(this,function(n){return e=new Promise(function(r){var s=null;if(t instanceof HTMLScriptElement)s=t;else{s=document.createElement("script");var i=typeof t!="string"?t:{type:"text/javascript",src:t};Object.entries(i).forEach(function(o){var c=o[0],l=o[1];s.setAttribute(c,l)})}s.src&&(s.onload=s.onerror=function(){r()}),document.body.appendChild(s),s.src||r()}),[2,e]})})},Be=function(t){var e=null;if(t instanceof HTMLLinkElement)e=t;else{var n=typeof t!="string"?t:{rel:"stylesheet",type:"text/css",href:t};e=document.createElement("link"),Object.entries(n).forEach(function(r){var s=r[0],i=r[1];e.setAttribute(s,i)})}document.head.appendChild(e)},j={loadScript:_e,loadLink:Be},Ae=function(){function t(e){this.eventEmitter=new ye,this.stores={},this.apps={},this.loadingApps={},this.conf=L({assets:{}}),this.middlewares=[],this.name=e,this.composedMiddlewareFn=lt(this.middlewares)}return t.prototype.isRallieCoreApp=function(e){return this.apps[e]&&typeof this.apps[e]!="boolean"},t.prototype.createContext=function(e){var n={name:e,loadScript:j.loadScript,loadLink:j.loadLink};return n},t.prototype.loadResourcesFromAssetsConfig=function(e){return b(this,void 0,void 0,function(){var n,r,s,i,o,c,l,a,u;return y(this,function(f){switch(f.label){case 0:if(n=e.name,r=e.loadScript,s=r===void 0?j.loadScript:r,i=e.loadLink,o=i===void 0?j.loadLink:i,c=this.conf.assets,!c[n])return[3,5];if(c[n].css&&c[n].css.forEach(function(B){o(B)}),!c[n].js)return[3,4];l=0,a=c[n].js,f.label=1;case 1:return l<a.length?(u=a[l],[4,s(u)]):[3,4];case 2:f.sent(),f.label=3;case 3:return l++,[3,1];case 4:return[3,6];case 5:throw new Error(d.resourceNotDeclared(n,this.name));case 6:return[2]}})})},t.prototype.innerActivateApp=function(e,n){return b(this,void 0,void 0,function(){var r,s,i,o,c=this;return y(this,function(l){switch(l.label){case 0:return[4,this.loadApp(e)];case 1:return l.sent(),this.isRallieCoreApp(e)?(r=this.apps[e],[4,this.loadRelatedApps(r)]):[3,4];case 2:if(l.sent(),n.includes(e))throw s=n.indexOf(e),i=g(g([],n.slice(s),!0),[e],!1),new Error(d.circularDependencies(e,i));return n.push(e),r.activated||(o=function(){return b(c,void 0,void 0,function(){var a;return y(this,function(u){switch(u.label){case 0:return[4,this.activateDependencies(r,n)];case 1:return u.sent(),a=r.doActivate,a?[4,Promise.resolve(r.doActivate())]:[3,3];case 2:a=u.sent(),u.label=3;case 3:return[2]}})})},r.activated=o()),[4,r.activated];case 3:l.sent(),n.pop(),l.label=4;case 4:return[2]}})})},t.prototype.activateDependencies=function(e,n){return b(this,void 0,void 0,function(){var r,s,i;return y(this,function(o){switch(o.label){case 0:if(e.dependencies.length===0)return[3,4];r=0,s=e.dependencies,o.label=1;case 1:return r<s.length?(i=s[r],[4,this.innerActivateApp(i,n)]):[3,4];case 2:o.sent(),o.label=3;case 3:return r++,[3,1];case 4:return[2]}})})},t.prototype.loadRelatedApps=function(e){return b(this,void 0,void 0,function(){var n=this;return y(this,function(r){switch(r.label){case 0:return[4,Promise.all(e.relatedApps.map(function(s){return n.loadApp(s)}))];case 1:return r.sent(),[2]}})})},t.prototype.createSocket=function(){return new me(this.eventEmitter,this.stores)},t.prototype.existApp=function(e){return!!this.apps[e]},t.prototype.createApp=function(e){if(this.existApp(e))throw new Error(d.createExistingApp(e));var n=new Se(e);return this.apps[e]=n,n},t.prototype.loadApp=function(e){return b(this,void 0,void 0,function(){var n=this;return y(this,function(r){switch(r.label){case 0:return this.apps[e]?[3,2]:(this.loadingApps[e]||(this.loadingApps[e]=new Promise(function(s,i){var o=n.createContext(e);n.composedMiddlewareFn(o,n.loadResourcesFromAssetsConfig.bind(n)).then(function(){var c=e.startsWith("lib:");c&&!n.apps[e]&&(n.apps[e]=!0),n.apps[e]||i(new Error(d.appNotCreated(e))),s()}).catch(function(c){i(c)})})),[4,this.loadingApps[e]]);case 1:r.sent(),r.label=2;case 2:return[2]}})})},t.prototype.activateApp=function(e){return b(this,void 0,void 0,function(){return y(this,function(n){switch(n.label){case 0:return[4,this.innerActivateApp(e,[])];case 1:return n.sent(),[2]}})})},t.prototype.config=function(e){return this.conf=A(A(A({},this.conf),e),{assets:A(A({},this.conf.assets),(e==null?void 0:e.assets)||{})}),this},t.prototype.use=function(e){if(typeof e!="function")throw new Error(d.wrongMiddlewareType());return this.middlewares.push(e),this.composedMiddlewareFn=lt(this.middlewares),this},t}(),xe={},tt="DEFAULT_BUS",Re=function(t){if(t===void 0&&(t=tt),window.RALLIE_BUS_STORE===void 0&&Reflect.defineProperty(window,"RALLIE_BUS_STORE",{value:xe,writable:!1}),window.RALLIE_BUS_STORE[t])throw new Error(d.duplicatedBus(t));var e=new Ae(t);return Reflect.defineProperty(window.RALLIE_BUS_STORE,t,{value:e,writable:!1}),e},xt=function(t){return t===void 0&&(t=tt),window.RALLIE_BUS_STORE&&window.RALLIE_BUS_STORE[t]},Rt=function(t){t===void 0&&(t=tt);var e=null,n=!1,r=xt(t);return r?(e=r,n=!1):(e=Re(t),n=!0),[e,n]},et={CREATED_BLOCK:Symbol("createBlock"),CONNECTED_BLOCK:Symbol("connectedBlock")},p={privateBus:function(t){return"".concat(t,".bus")},stateNamespace:function(t){return"".concat(t,".state")},isGlobalBusAccessible:"isGlobalBusAccessible",exportMethodName:"__RallieInnerExport__"},O=function(t){return"[rallie] ".concat(t)},T={stateNotInitialized:function(t){return O(" the block ".concat(t,`'s state is not initialized, please check:
`)+"1. whether the block ".concat(t,` is loaded.
`)+"2. whether the block ".concat(t," has initialized the state"))},duplicatedBlockName:function(t){return O("the block ".concat(t," is already registered before, please rename your block"))},invalidBlock:function(t){return O("failed to register the block ".concat(t," because it is not a valid created block"))},stateIsReadonly:function(t){return O("the state of ".concat(t," is readonly"))},operateBeforeRegister:function(t,e){return O("the block ".concat(t," can not ").concat(e," any other block unless it's registered"))}},Te={duplicatedExports:function(t){return O("you can only export once in the block ".concat(t))}},Tt=function(){function t(e){var n=this;this.name=e;var r=Rt(p.privateBus(e))[0];this.socket=r.createSocket(),this.events=this.socket.createBroadcaster(),this.methods=this.socket.createUnicaster(),Reflect.defineProperty(this,"state",{get:function(){return n.socket.getState(p.stateNamespace(n.name))},set:function(){throw new Error(T.stateIsReadonly(n.name))}})}return t.prototype.setState=function(e,n){if(this.socket.existState(p.stateNamespace(this.name)))return this.socket.setState(p.stateNamespace(this.name),e,n);throw new Error(T.stateNotInitialized(this.name))},t.prototype.watchState=function(e){if(this.socket.existState(p.stateNamespace(this.name)))return this.socket.watchState(p.stateNamespace(this.name),e);throw new Error(T.stateNotInitialized(this.name))},t.prototype.listenEvents=function(e){return this.socket.onBroadcast(e)},t}(),Oe=function(t){ht(e,t);function e(n){var r=t.call(this,n)||this;return r.symbol=et.CONNECTED_BLOCK,r.innerMethods=r.socket.createUnicaster(),r}return e.prototype.import=function(){return this.innerMethods[p.exportMethodName]()},e}(Tt),Ot=new Map,Ie=function(t){ht(e,t);function e(n,r,s,i){var o=t.call(this,n)||this;return o.connectedBlocks={},o.symbol=et.CREATED_BLOCK,o.globalBus=r,o.globalSocket=s,o.isEntry=i,Ot.set(n,o.socket),o}return e.prototype.addMethods=function(n){return this.socket.onUnicast(n)},e.prototype.connect=function(n){return this.connectedBlocks[n]||(this.connectedBlocks[n]=new Oe(n)),this.connectedBlocks[n]},e.prototype.load=function(n){if(this.globalBus.existApp(this.name))return this.globalBus.loadApp(n);throw new Error(T.operateBeforeRegister(this.name,"load"))},e.prototype.activate=function(n){if(this.globalBus.existApp(this.name))return this.globalBus.activateApp(n);throw new Error(T.operateBeforeRegister(this.name,"activate"))},e.prototype.run=function(n){var r;return It(this,void 0,void 0,function(){var s,i,o,c,l=this;return kt(this,function(a){switch(a.label){case 0:return s=this.isEntry||((r=this.globalSocket.getState(p.isGlobalBusAccessible))===null||r===void 0?void 0:r.value),i=function(u){l.isEntry&&l.globalSocket.setState(p.isGlobalBusAccessible,u?"unfreeze the enviroment":"freeze the enviroment",function(f){f.value=u})},o={isEntry:this.isEntry,use:function(u){s&&l.globalBus.use(u)},config:function(u){s&&l.globalBus.config(u)},freeze:function(){i(!1)},unfreeze:function(){i(!0)}},c=n(new Proxy(o,{get:function(u,f,B){return f==="conf"?JSON.parse(JSON.stringify(l.globalBus.conf)):Reflect.get(u,f,B)},set:function(){return!1}})),[4,Promise.resolve(c)];case 1:return a.sent(),[2]}})})},e}(Tt),ke=function(){function t(e){var n,r=this;this.createdBlock=e,this.exports={},this.exported=!1,this.app=xt().createApp(e.name),this.socket=Ot.get(e.name),this.socket.onUnicast((n={},n[p.exportMethodName]=function(){return r.exports},n))}return t.prototype.relyOn=function(e){return this.app.relyOn(e),this},t.prototype.relateTo=function(e){return this.app.relateTo(e),this},t.prototype.initState=function(e,n){return this.socket.initState(p.stateNamespace(this.createdBlock.name),e,n),this},t.prototype.export=function(e){return this.exported?console.warn(Te.duplicatedExports(this.createdBlock.name)):(Object.freeze(e),this.exports=e,this.createdBlock.exports=e,this.exported=!0),this},t.prototype.onActivate=function(e){return this.app.onActivate(e),this},t}();function Ce(t){var e=Rt(),n=e[0],r=e[1];if(n.existApp(t))throw new Error(T.duplicatedBlockName(t));var s=n.createSocket();return r&&s.initState(p.isGlobalBusAccessible,{value:!0},!0),new Ie(t,n,s,r)}function Ne(t){if(t.symbol===et.CREATED_BLOCK)return new ke(t);throw new Error(T.invalidBlock(t.name))}const Le="modulepreload",Me=function(t){return"/rallie/"+t},ft={},Pe=function(e,n,r){if(!n||n.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(n.map(i=>{if(i=Me(i),i in ft)return;ft[i]=!0;const o=i.endsWith(".css"),c=o?'[rel="stylesheet"]':"";if(!!r)for(let u=s.length-1;u>=0;u--){const f=s[u];if(f.href===i&&(!o||f.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${i}"]${c}`))return;const a=document.createElement("link");if(a.rel=o?"stylesheet":Le,o||(a.as="script",a.crossOrigin=""),a.href=i,document.head.appendChild(a),o)return new Promise((u,f)=>{a.addEventListener("load",u),a.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>e())};export{Pe as _,Ce as c,Ne as r};
