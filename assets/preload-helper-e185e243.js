function Qt(t,e,s,i){return new(s||(s=Promise))(function(n,r){function a(l){try{h(i.next(l))}catch(u){r(u)}}function o(l){try{h(i.throw(l))}catch(u){r(u)}}function h(l){var u;l.done?n(l.value):(u=l.value,u instanceof s?u:new s(function(d){d(u)})).then(a,o)}h((i=i.apply(t,e||[])).next())})}function E(t,e,s,i){return new(s||(s=Promise))(function(n,r){function a(l){try{h(i.next(l))}catch(u){r(u)}}function o(l){try{h(i.throw(l))}catch(u){r(u)}}function h(l){var u;l.done?n(l.value):(u=l.value,u instanceof s?u:new s(function(d){d(u)})).then(a,o)}h((i=i.apply(t,e||[])).next())})}function c(t,e,s,i){if(s==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?i:s==="a"?i.call(t):i?i.value:e.get(t)}function A(t,e,s,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(t,s):n?n.value=s:e.set(t,s),s}const Xt=Object.assign,Yt=Object.prototype.hasOwnProperty,V=(t,e)=>Yt.call(t,e),B=Array.isArray,J=t=>Lt(t)==="[object Map]",lt=t=>typeof t=="symbol",X=t=>t!==null&&typeof t=="object",Zt=Object.prototype.toString,Lt=t=>Zt.call(t),te=t=>Lt(t).slice(8,-1),ht=t=>typeof t=="string"&&t!=="NaN"&&t[0]!=="-"&&""+parseInt(t,10)===t,$t=(t,e)=>!Object.is(t,e),ee=t=>{const e=parseFloat(t);return isNaN(e)?t:e};let se;function Pt(t,e=se){e&&e.active&&e.effects.push(t)}const Mt=t=>{const e=new Set(t);return e.w=0,e.n=0,e},jt=t=>(t.w&S)>0,Nt=t=>(t.n&S)>0,tt=new WeakMap;let M=0,S=1;const et=30;let g;const O=Symbol(""),st=Symbol("");class ie{constructor(e,s=null,i){this.fn=e,this.scheduler=s,this.active=!0,this.deps=[],this.parent=void 0,Pt(this,i)}run(){if(!this.active)return this.fn();let e=g,s=L;for(;e;){if(e===this)return;e=e.parent}try{return this.parent=g,g=this,L=!0,S=1<<++M,M<=et?(({deps:i})=>{if(i.length)for(let n=0;n<i.length;n++)i[n].w|=S})(this):vt(this),this.fn()}finally{M<=et&&(i=>{const{deps:n}=i;if(n.length){let r=0;for(let a=0;a<n.length;a++){const o=n[a];jt(o)&&!Nt(o)?o.delete(i):n[r++]=o,o.w&=~S,o.n&=~S}n.length=r}})(this),S=1<<--M,g=this.parent,L=s,this.parent=void 0,this.deferStop&&this.stop()}}stop(){g===this?this.deferStop=!0:this.active&&(vt(this),this.onStop&&this.onStop(),this.active=!1)}}function vt(t){const{deps:e}=t;if(e.length){for(let s=0;s<e.length;s++)e[s].delete(t);e.length=0}}let L=!0;const mt=[];function m(t,e,s){if(L&&g){let i=tt.get(t);i||tt.set(t,i=new Map);let n=i.get(s);n||i.set(s,n=Mt()),function(r,a){let o=!1;M<=et?Nt(r)||(r.n|=S,o=!jt(r)):o=!r.has(g),o&&(r.add(g),g.deps.push(r))}(n)}}function R(t,e,s,i,n,r){const a=tt.get(t);if(!a)return;let o=[];if(e==="clear")o=[...a.values()];else if(s==="length"&&B(t)){const h=ee(i);a.forEach((l,u)=>{(u==="length"||u>=h)&&o.push(l)})}else switch(s!==void 0&&o.push(a.get(s)),e){case"add":B(t)?ht(s)&&o.push(a.get("length")):(o.push(a.get(O)),J(t)&&o.push(a.get(st)));break;case"delete":B(t)||(o.push(a.get(O)),J(t)&&o.push(a.get(st)));break;case"set":J(t)&&o.push(a.get(O))}if(o.length===1)o[0]&&yt(o[0]);else{const h=[];for(const l of o)l&&h.push(...l);yt(Mt(h))}}function yt(t,e){const s=B(t)?t:[...t];for(const i of s)i.computed&&gt(i);for(const i of s)i.computed||gt(i)}function gt(t,e){(t!==g||t.allowRecurse)&&(t.scheduler?t.scheduler():t.run())}const ne=function(t,e){const s=Object.create(null),i=t.split(",");for(let n=0;n<i.length;n++)s[i[n]]=!0;return e?n=>!!s[n.toLowerCase()]:n=>!!s[n]}("__proto__,__v_isRef,__isVue"),Wt=new Set(Object.getOwnPropertyNames(Symbol).filter(t=>t!=="arguments"&&t!=="caller").map(t=>Symbol[t]).filter(lt)),re=Tt(),oe=Tt(!0),bt=function(){const t={};return["includes","indexOf","lastIndexOf"].forEach(e=>{t[e]=function(...s){const i=f(this);for(let r=0,a=this.length;r<a;r++)m(i,"get",r+"");const n=i[e](...s);return n===-1||n===!1?i[e](...s.map(f)):n}}),["push","pop","shift","unshift","splice"].forEach(e=>{t[e]=function(...s){mt.push(L),L=!1;const i=f(this)[e].apply(this,s);return function(){const n=mt.pop();L=n===void 0||n}(),i}}),t}();function Tt(t=!1,e=!1){return function(s,i,n){if(i==="__v_isReactive")return!t;if(i==="__v_isReadonly")return t;if(i==="__v_isShallow")return e;if(i==="__v_raw"&&n===(t?e?ve:Ct:e?we:zt).get(s))return s;const r=B(s);if(!t&&r&&V(bt,i))return Reflect.get(bt,i,n);const a=Reflect.get(s,i,n);return(lt(i)?Wt.has(i):ne(i))?a:(t||m(s,"get",i),e?a:j(a)?r&&ht(i)?a:a.value:X(a)?t?C(a):ft(a):a)}}const ae={get:re,set:function(t=!1){return function(e,s,i,n){let r=e[s];if(it(r)&&j(r)&&!j(i))return!1;if(!t&&(function(h){return!(!h||!h.__v_isShallow)}(i)||it(i)||(r=f(r),i=f(i)),!B(e)&&j(r)&&!j(i)))return r.value=i,!0;const a=B(e)&&ht(s)?Number(s)<e.length:V(e,s),o=Reflect.set(e,s,i,n);return e===f(n)&&(a?$t(i,r)&&R(e,"set",s,i):R(e,"add",s,i)),o}}(),deleteProperty:function(t,e){const s=V(t,e);t[e];const i=Reflect.deleteProperty(t,e);return i&&s&&R(t,"delete",e,void 0),i},has:function(t,e){const s=Reflect.has(t,e);return lt(e)&&Wt.has(e)||m(t,"has",e),s},ownKeys:function(t){return m(t,"iterate",B(t)?"length":O),Reflect.ownKeys(t)}},ce={get:oe,set:(t,e)=>!0,deleteProperty:(t,e)=>!0},ut=t=>t,Y=t=>Reflect.getPrototypeOf(t);function I(t,e,s=!1,i=!1){const n=f(t=t.__v_raw),r=f(e);s||(e!==r&&m(n,"get",e),m(n,"get",r));const{has:a}=Y(n),o=i?ut:s?pt:dt;return a.call(n,e)?o(t.get(e)):a.call(n,r)?o(t.get(r)):void(t!==n&&t.get(e))}function K(t,e=!1){const s=this.__v_raw,i=f(s),n=f(t);return e||(t!==n&&m(i,"has",t),m(i,"has",n)),t===n?s.has(t):s.has(t)||s.has(n)}function D(t,e=!1){return t=t.__v_raw,!e&&m(f(t),"iterate",O),Reflect.get(t,"size",t)}function Et(t){t=f(t);const e=f(this);return Y(e).has.call(e,t)||(e.add(t),R(e,"add",t,t)),this}function _t(t,e){e=f(e);const s=f(this),{has:i,get:n}=Y(s);let r=i.call(s,t);r||(t=f(t),r=i.call(s,t));const a=n.call(s,t);return s.set(t,e),r?$t(e,a)&&R(s,"set",t,e):R(s,"add",t,e),this}function kt(t){const e=f(this),{has:s,get:i}=Y(e);let n=s.call(e,t);n||(t=f(t),n=s.call(e,t)),i&&i.call(e,t);const r=e.delete(t);return n&&R(e,"delete",t,void 0),r}function St(){const t=f(this),e=t.size!==0,s=t.clear();return e&&R(t,"clear",void 0,void 0),s}function G(t,e){return function(s,i){const n=this,r=n.__v_raw,a=f(r),o=e?ut:t?pt:dt;return!t&&m(a,"iterate",O),r.forEach((h,l)=>s.call(i,o(h),o(l),n))}}function F(t,e,s){return function(...i){const n=this.__v_raw,r=f(n),a=J(r),o=t==="entries"||t===Symbol.iterator&&a,h=t==="keys"&&a,l=n[t](...i),u=s?ut:e?pt:dt;return!e&&m(r,"iterate",h?st:O),{next(){const{value:d,done:Z}=l.next();return Z?{value:d,done:Z}:{value:o?[u(d[0]),u(d[1])]:u(d),done:Z}},[Symbol.iterator](){return this}}}}function k(t){return function(...e){return t!=="delete"&&this}}const[le,he,ue,fe]=function(){const t={get(n){return I(this,n)},get size(){return D(this)},has:K,add:Et,set:_t,delete:kt,clear:St,forEach:G(!1,!1)},e={get(n){return I(this,n,!1,!0)},get size(){return D(this)},has:K,add:Et,set:_t,delete:kt,clear:St,forEach:G(!1,!0)},s={get(n){return I(this,n,!0)},get size(){return D(this,!0)},has(n){return K.call(this,n,!0)},add:k("add"),set:k("set"),delete:k("delete"),clear:k("clear"),forEach:G(!0,!1)},i={get(n){return I(this,n,!0,!0)},get size(){return D(this,!0)},has(n){return K.call(this,n,!0)},add:k("add"),set:k("set"),delete:k("delete"),clear:k("clear"),forEach:G(!0,!0)};return["keys","values","entries",Symbol.iterator].forEach(n=>{t[n]=F(n,!1,!1),s[n]=F(n,!0,!1),e[n]=F(n,!1,!0),i[n]=F(n,!0,!0)}),[t,s,e,i]}();function Ut(t,e){const s=e?t?fe:ue:t?he:le;return(i,n,r)=>n==="__v_isReactive"?!t:n==="__v_isReadonly"?t:n==="__v_raw"?i:Reflect.get(V(s,n)&&n in i?s:i,n,r)}const de={get:Ut(!1,!1)},pe={get:Ut(!0,!1)},zt=new WeakMap,we=new WeakMap,Ct=new WeakMap,ve=new WeakMap;function ft(t){return it(t)?t:It(t,!1,ae,de,zt)}function C(t){return It(t,!0,ce,pe,Ct)}function It(t,e,s,i,n){if(!X(t)||t.__v_raw&&(!e||!t.__v_isReactive))return t;const r=n.get(t);if(r)return r;const a=(o=t).__v_skip||!Object.isExtensible(o)?0:function(l){switch(l){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}(te(o));var o;if(a===0)return t;const h=new Proxy(t,a===2?i:s);return n.set(t,h),h}function it(t){return!(!t||!t.__v_isReadonly)}function f(t){const e=t&&t.__v_raw;return e?f(e):t}const dt=t=>X(t)?ft(t):t,pt=t=>X(t)?C(t):t;function j(t){return!(!t||t.__v_isRef!==!0)}const me=t=>`[@rallie/core] you are trying to remove a listener of the broadcast event ${t}, but ${t} hasn't been registed as a broadcast event`,ye=t=>`[@rallie/core] you are trying to remove a listener of the broadcast event ${t}, but the listener hasn't been registed`,ge=t=>`[@rallie/core] one of the callbacks of the broadcast event ${t} throws an uncaught error`,be=t=>`[@rallie/core] you are trying to remove a listener of the unicast event ${t}, but ${t} hasn't been registed as a unicast event`,Ee=t=>`[@rallie/core] you are trying to register a unicast event ${t}, but it has been registered before`,_e=t=>`[@rallie/core] you have emitted ${t} unicast, but there is no listener of this event`,ke=t=>`[@rallie/core] ${t} is existing, you are not allowed to create it again`,Se=(t,e)=>`[@rallie/core] can not find any assets of the app ${t} on the bus ${e}`,Be=t=>`[@rallie/core] you are trying to activate app ${t}, but it was not created`,Re=t=>`[@rallie/core] state ${t} is private, you are not allowed to set it`,xe=t=>`[@rallie/core] please describe your action when you modify the state ${t}`,Kt=t=>`[@rallie/core] it's not allowed to set or watch state ${t} before it is initialized`,Ae=t=>`[@rallie/core] duplicated initialized state ${t}`,Oe=t=>`[@rallie/core] it's not allowed to initialized state ${t} to a primitive value`,Le=t=>`[@rallie/core] the bus named ${t} has been defined before, please rename your bus`,$e=(t,e)=>`[@rallie/core] There is a circular dependency when activating the app ${t}, and the circular path is ${e.join("->")}`,Pe=()=>"[@rallie/core] next() called multiple times in the middleware",Me=()=>"[@rallie/core] the middleware must be a function",je=(t,e)=>`[@rallie/core] the event ${t} is not in the events pool that you specified when calling on${e?"Unicast":"Broadcast"}`,Bt=t=>(e,s)=>{let i=-1;const n=r=>{if(r<=i)return Promise.reject(new Error(Pe()));i=r;let a=t[r];if(r===t.length&&(a=s),!a)return Promise.resolve();try{return Promise.resolve(a(e,n.bind(null,r+1)))}catch(o){return Promise.reject(o)}};return n(0)};var b,x,q,N,W,w,y,nt,Dt;class Ne{constructor(){b.set(this,{}),x.set(this,{})}addBroadcastEventListener(e,s){c(this,b,"f")[e]=c(this,b,"f")[e]||new Set,c(this,b,"f")[e].add(s)}addUnicastEventListener(e,s){if(c(this,x,"f")[e])throw new Error(Ee(e));c(this,x,"f")[e]=s}removeBroadcastEventListener(e,s){const i=c(this,b,"f")[e];if(!i){const n=me(e);throw new Error(n)}if(!i.has(s)){const n=ye(e);throw new Error(n)}i.delete(s)}removeUnicastEventListener(e){if(!c(this,x,"f")[e]){const s=be(e);throw new Error(s)}delete c(this,x,"f")[e]}emitBroadcast(e,...s){c(this,b,"f")[e]=c(this,b,"f")[e]||new Set,c(this,b,"f")[e].forEach(i=>{try{i(...s)}catch(n){console.error(ge(e)),console.error(n)}})}emitUnicast(e,...s){const i=c(this,x,"f")[e];if(i)return i(...s);throw new Error(_e(e))}}b=new WeakMap,x=new WeakMap;class We{constructor(e,s){q.set(this,void 0),N.set(this,void 0),A(this,q,e,"f"),A(this,N,s,"f"),c(this,N,"f")[e].watchers.add(this)}do(e){return this.handler=e,()=>this.unwatch()}unwatch(){this==null||this.stopEffect(),this.handler=null;const e=c(this,N,"f")[c(this,q,"f")].watchers;e.has(this)&&e.delete(this)}}q=new WeakMap,N=new WeakMap;class Te{constructor(e,s){W.add(this),w.set(this,void 0),y.set(this,void 0),A(this,w,e,"f"),A(this,y,s,"f")}onBroadcast(e){return Object.entries(e).forEach(([s,i])=>{c(this,w,"f").addBroadcastEventListener(s,i)}),s=>{c(this,W,"m",nt).call(this,e,!1,s)}}onUnicast(e){return Object.entries(e).forEach(([s,i])=>{try{c(this,w,"f").addUnicastEventListener(s,i)}catch(n){console.error(n)}}),s=>{c(this,W,"m",nt).call(this,e,!0,s)}}createBroadcaster(e){return new Proxy({},{get:(s,i)=>(...n)=>(e==null||e(i),c(this,w,"f").emitBroadcast(i,...n)),set:()=>!1})}createUnicaster(e){return new Proxy({},{get:(s,i)=>(...n)=>(e==null||e(i),c(this,w,"f").emitUnicast(i,...n)),set:()=>!1})}existState(e){return!!c(this,y,"f")[e]}initState(e,s,i=!1){if(this.existState(e))throw new Error(Ae(e));if(["string","number","boolean","undefined"].includes(typeof s))throw new Error(Oe(e));return c(this,y,"f")[e]={state:ft(s),owner:i?this:null,watchers:new Set},c(this,w,"f").emitBroadcast("$state-initialized",e),this.getState(e)}getState(e,s){if(this.existState(e)){const i=C(c(this,y,"f")[e].state);return s?s(i):i}return null}setState(e,s,i){return E(this,void 0,void 0,function*(){const n=c(this,W,"m",Dt).call(this,e);if(!s)throw new Error(xe(e));{const r=i(n);yield Promise.resolve(r)}})}watchState(e,s){if(!this.existState(e)){const o=Kt(e);throw new Error(o)}let i=!1;const n=C(c(this,y,"f")[e].state),r=new We(e,c(this,y,"f")),a=function(o,h){o.effect&&(o=o.effect.fn);const l=new ie(o);h&&(Xt(l,h),h.scope&&Pt(l,h.scope)),h&&h.lazy||l.run();const u=l.run.bind(l);return u.effect=l,u}(()=>s(n),{lazy:!0,scheduler:()=>{i||(i=!0,Promise.resolve().then(()=>{var o;const h=f(s(n));(o=r.handler)===null||o===void 0||o.call(r,h,r.oldWatchingStates),r.oldWatchingStates=f(h),i=!1}))}});return r.oldWatchingStates=a(),r.stopEffect=()=>a.effect.stop(),r}}w=new WeakMap,y=new WeakMap,W=new WeakSet,nt=function(t,e,s){let i=e?c(this,w,"f").removeUnicastEventListener:c(this,w,"f").removeBroadcastEventListener;i=i.bind(c(this,w,"f")),s?t[s]?(i(s,t[s]),delete t[s]):console.warn(je(s,e)):Object.entries(t).forEach(([n,r])=>{i(n,r)})},Dt=function(t){if(!this.existState(t)){const s=Kt(t);throw new Error(s)}const e=c(this,y,"f")[t].owner;if(e!==this&&e!==null){const s=Re(t);throw new Error(s)}return c(this,y,"f")[t].state};class Ue{constructor(e){this.name=e,this.activated=null,this.dependencies=[],this.relatedApps=[],this.name=e,this.isRallieCoreApp=!0}relateTo(e){return this.relatedApps=Array.from(new Set([...this.relatedApps,...e])),this}relyOn(e){return this.relateTo(e),this.dependencies=Array.from(new Set([...this.dependencies,...e])),this}onActivate(e){return this.doActivate=e,this}}var _,Q,rt,ot,v,T,U,z,Rt,Gt,Ft,at,xt,At,H={loadScript:t=>E(void 0,void 0,void 0,function*(){return new Promise(e=>{let s=null;t instanceof HTMLScriptElement?s=t:(s=document.createElement("script"),Object.entries(typeof t!="string"?t:{type:"text/javascript",src:t}).forEach(([n,r])=>{s.setAttribute(n,r)})),s.src&&(s.onload=s.onerror=()=>{e()}),document.body.appendChild(s),s.src||e()})}),loadLink:t=>{let e=null;if(t instanceof HTMLLinkElement)e=t;else{const s=typeof t!="string"?t:{rel:"stylesheet",type:"text/css",href:t};e=document.createElement("link"),Object.entries(s).forEach(([i,n])=>{e.setAttribute(i,n)})}document.head.appendChild(e)}};class ze{constructor(e){_.add(this),Q.set(this,void 0),rt.set(this,new Ne),ot.set(this,{}),v.set(this,{}),T.set(this,{}),this.conf=C({assets:{}}),U.set(this,[]),z.set(this,void 0),A(this,Q,e,"f"),A(this,z,Bt(c(this,U,"f")),"f")}createSocket(){return new Te(c(this,rt,"f"),c(this,ot,"f"))}existApp(e){return!!c(this,v,"f")[e]}createApp(e){if(this.existApp(e))throw new Error(ke(e));const s=new Ue(e);return c(this,v,"f")[e]=s,s}loadApp(e){return E(this,void 0,void 0,function*(){c(this,v,"f")[e]||(c(this,T,"f")[e]||(c(this,T,"f")[e]=new Promise((s,i)=>{const n=c(this,_,"m",Gt).call(this,e);c(this,z,"f").call(this,n,c(this,_,"m",Ft).bind(this)).then(()=>{e.startsWith("lib:")&&!c(this,v,"f")[e]&&(c(this,v,"f")[e]=!0),c(this,v,"f")[e]||i(new Error(Be(e))),s()}).catch(r=>{i(r)})})),yield c(this,T,"f")[e])})}activateApp(e){return E(this,void 0,void 0,function*(){yield c(this,_,"m",at).call(this,e,[])})}config(e){return this.conf=Object.assign(Object.assign(Object.assign({},this.conf),e),{assets:Object.assign(Object.assign({},this.conf.assets),(e==null?void 0:e.assets)||{})}),this}use(e){if(typeof e!="function")throw new Error(Me());return c(this,U,"f").push(e),A(this,z,Bt(c(this,U,"f")),"f"),this}}Q=new WeakMap,rt=new WeakMap,ot=new WeakMap,v=new WeakMap,T=new WeakMap,U=new WeakMap,z=new WeakMap,_=new WeakSet,Rt=function(t){return c(this,v,"f")[t]&&typeof c(this,v,"f")[t]!="boolean"},Gt=function(t){return{name:t,loadScript:H.loadScript,loadLink:H.loadLink}},Ft=function(t){return E(this,void 0,void 0,function*(){const{name:e,loadScript:s=H.loadScript,loadLink:i=H.loadLink}=t,{assets:n}=this.conf;if(!n[e])throw new Error(Se(e,c(this,Q,"f")));if(n[e].css&&n[e].css.forEach(r=>{i(r)}),n[e].js)for(const r of n[e].js)yield s(r)})},at=function(t,e){return E(this,void 0,void 0,function*(){if(yield this.loadApp(t),c(this,_,"m",Rt).call(this,t)){const s=c(this,v,"f")[t];if(yield c(this,_,"m",At).call(this,s),e.includes(t)){const i=e.indexOf(t),n=[...e.slice(i),t];throw new Error($e(t,n))}if(e.push(t),!s.activated){const i=()=>E(this,void 0,void 0,function*(){yield c(this,_,"m",xt).call(this,s,e),s.doActivate&&(yield Promise.resolve(s.doActivate()))});s.activated=i()}yield s.activated,e.pop()}})},xt=function(t,e){return E(this,void 0,void 0,function*(){if(t.dependencies.length!==0)for(const s of t.dependencies)yield c(this,_,"m",at).call(this,s,e)})},At=function(t){return E(this,void 0,void 0,function*(){yield Promise.all(t.relatedApps.map(e=>this.loadApp(e)))})};const Ce={},ct="DEFAULT_BUS",Ht=(t=ct)=>window.RALLIE_BUS_STORE&&window.RALLIE_BUS_STORE[t],Jt=(t=ct)=>{let e=null,s=!1;const i=Ht(t);return i?(e=i,s=!1):(e=((n=ct)=>{if(window.RALLIE_BUS_STORE===void 0&&Reflect.defineProperty(window,"RALLIE_BUS_STORE",{value:Ce,writable:!1}),window.RALLIE_BUS_STORE[n])throw new Error(Le(n));{const r=new ze(n);return Reflect.defineProperty(window.RALLIE_BUS_STORE,n,{value:r,writable:!1}),r}})(t),s=!0),[e,s]},wt={CREATED_BLOCK:Symbol("createBlock"),CONNECTED_BLOCK:Symbol("connectedBlock")},p={privateBus:t=>`${t}.bus`,stateNamespace:t=>`${t}.state`,isGlobalBusAccessible:"isGlobalBusAccessible",exportMethodName:"__RallieInnerExport__"},P=t=>`[rallie] ${t}`,$={stateNotInitialized:t=>P(` the block ${t}'s state is not initialized, please check:
1. whether the block ${t} is loaded.
2. whether the block ${t} has initialized the state`),duplicatedBlockName:t=>P(`the block ${t} is already registered before, please rename your block`),invalidBlock:t=>P(`failed to register the block ${t} because it is not a valid created block`),stateIsReadonly:t=>P(`the state of ${t} is readonly`),operateBeforeRegister:(t,e)=>P(`the block ${t} can not ${e} any other block unless it's registered`)},Ie=t=>P(`you can only export once in the block ${t}`);class qt{constructor(e){this.name=e;const[s]=Jt(p.privateBus(e));this.socket=s.createSocket(),this.events=this.socket.createBroadcaster(),this.methods=this.socket.createUnicaster(),Reflect.defineProperty(this,"state",{get:()=>this.socket.getState(p.stateNamespace(this.name)),set:()=>{throw new Error($.stateIsReadonly(this.name))}})}setState(e,s){if(this.socket.existState(p.stateNamespace(this.name)))return this.socket.setState(p.stateNamespace(this.name),e,s);throw new Error($.stateNotInitialized(this.name))}watchState(e){if(this.socket.existState(p.stateNamespace(this.name)))return this.socket.watchState(p.stateNamespace(this.name),e);throw new Error($.stateNotInitialized(this.name))}listenEvents(e){return this.socket.onBroadcast(e)}}class Ke extends qt{constructor(e){super(e),this.symbol=wt.CONNECTED_BLOCK,this.innerMethods=this.socket.createUnicaster()}import(){return this.innerMethods[p.exportMethodName]()}}const Vt=new Map;class De extends qt{constructor(e,s,i,n){super(e),this.connectedBlocks={},this.symbol=wt.CREATED_BLOCK,this.globalBus=s,this.globalSocket=i,this.isEntry=n,Vt.set(e,this.socket)}addMethods(e){return this.socket.onUnicast(e)}connect(e){return this.connectedBlocks[e]||(this.connectedBlocks[e]=new Ke(e)),this.connectedBlocks[e]}load(e){if(this.globalBus.existApp(this.name))return this.globalBus.loadApp(e);throw new Error($.operateBeforeRegister(this.name,"load"))}activate(e){if(this.globalBus.existApp(this.name))return this.globalBus.activateApp(e);throw new Error($.operateBeforeRegister(this.name,"activate"))}run(e){var s;return Qt(this,void 0,void 0,function*(){const i=this.isEntry||((s=this.globalSocket.getState(p.isGlobalBusAccessible))===null||s===void 0?void 0:s.value),n=o=>{this.isEntry&&this.globalSocket.setState(p.isGlobalBusAccessible,o?"unfreeze the enviroment":"freeze the enviroment",h=>{h.value=o})},r={isEntry:this.isEntry,use:o=>{i&&this.globalBus.use(o)},config:o=>{i&&this.globalBus.config(o)},freeze:()=>{n(!1)},unfreeze:()=>{n(!0)}},a=e(new Proxy(r,{get:(o,h,l)=>h==="conf"?JSON.parse(JSON.stringify(this.globalBus.conf)):Reflect.get(o,h,l),set:()=>!1}));yield Promise.resolve(a)})}}class Ge{constructor(e){this.createdBlock=e,this.exports={},this.exported=!1,this.app=Ht().createApp(e.name),this.socket=Vt.get(e.name),this.socket.onUnicast({[p.exportMethodName]:()=>this.exports})}relyOn(e){return this.app.relyOn(e),this}relateTo(e){return this.app.relateTo(e),this}initState(e,s){return this.socket.initState(p.stateNamespace(this.createdBlock.name),e,s),this}export(e){return this.exported?console.warn(Ie(this.createdBlock.name)):(Object.freeze(e),this.exports=e,this.createdBlock.exports=e,this.exported=!0),this}onActivate(e){return this.app.onActivate(e),this}}function Je(t){const[e,s]=Jt();if(e.existApp(t))throw new Error($.duplicatedBlockName(t));const i=e.createSocket();return s&&i.initState(p.isGlobalBusAccessible,{value:!0},!0),new De(t,e,i,s)}function qe(t){if(t.symbol===wt.CREATED_BLOCK)return new Ge(t);throw new Error($.invalidBlock(t.name))}const Fe="modulepreload",He=function(t){return"/rallie/"+t},Ot={},Ve=function(e,s,i){if(!s||s.length===0)return e();const n=document.getElementsByTagName("link");return Promise.all(s.map(r=>{if(r=He(r),r in Ot)return;Ot[r]=!0;const a=r.endsWith(".css"),o=a?'[rel="stylesheet"]':"";if(!!i)for(let u=n.length-1;u>=0;u--){const d=n[u];if(d.href===r&&(!a||d.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${r}"]${o}`))return;const l=document.createElement("link");if(l.rel=a?"stylesheet":Fe,a||(l.as="script",l.crossOrigin=""),l.href=r,document.head.appendChild(l),a)return new Promise((u,d)=>{l.addEventListener("load",u),l.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${r}`)))})})).then(()=>e())};export{Je as M,qe as P,Ve as _};
